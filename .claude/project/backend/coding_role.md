# backend のコーディング規約

## 基本原則
- Python 3.11+ を使用すること。
- 型ヒントを必須とし、すべての関数・メソッドに適切な型注釈を付けること。
- 可読性とメンテナンス性を重視し、明確で簡潔なコードを書くこと。
- セキュリティを重視し、認証・認可の実装を適切に行うこと。

## プロジェクト構成
- ディレクトリ構造は以下に従うこと：
  ```
  backend/
  ├── main.py                 # FastAPI アプリケーションのエントリーポイント
  ├── models/                 # SQLAlchemy モデル
  ├── schemas/                # Pydantic スキーマ
  ├── routes/                 # API ルート
  ├── services/               # ビジネスロジック
  ├── lib/                    # 共通ライブラリ
  ├── utils/                  # ユーティリティ関数
  └── pyproject.toml          # 依存関係・設定
  ```

## 依存関係管理
- `uv` を使用してパッケージ管理を行うこと。
- 依存関係は `pyproject.toml` で管理すること。
- 新しい依存関係を追加する際は、セキュリティと互換性を確認すること。

## コードフォーマット・リント
- Ruff を使用してコードフォーマットとリントを行うこと。
- 以下の設定に従うこと：
  - 行の長さ: 88文字
  - インデント: 4スペース
  - 文字列: ダブルクォート
  - Python バージョン: 3.9+

## FastAPI 関連
- 非同期関数 (`async def`) を使用すること。
- APIルートには適切なタグを付けること。
- レスポンスモデルを明示的に指定すること。
- HTTPステータスコードを適切に使用すること。
- エラーハンドリングには `HTTPException` を使用すること。

## データベース・SQLAlchemy
- SQLAlchemy を使用してデータベースアクセスを行うこと。
- モデルには `Base` クラスを継承すること。
- UUIDを主キーとして使用すること。
- ソフトデリート機能を実装すること（`is_deleted` フィールド）。
- 作成日時・更新日時を自動で管理すること。
- リレーションシップは `relationship()` で定義すること。

## Pydantic スキーマ
- API リクエスト・レスポンスには Pydantic スキーマを使用すること。
- バリデーション機能を積極的に活用すること。
- メールアドレスには `EmailStr` 型を使用すること。
- パスワードには適切な長さ制限を設けること。

## 認証・認可
- JWT トークンを使用した認証を実装すること。
- パスワードは bcrypt でハッシュ化すること。
- トークンのブラックリスト機能を実装すること。
- 認証が必要なエンドポイントには適切なミドルウェアを適用すること。

## ビジネスロジック
- サービスクラスを使用してビジネスロジックを分離すること。
- 静的メソッド (`@staticmethod`) を積極的に活用すること。
- データベースセッションは依存性注入で管理すること。
- 適切な例外処理を行うこと。

## エラーハンドリング
- カスタム例外クラスを定義すること。
- 適切なHTTPステータスコードを返すこと。
- エラーメッセージは明確で理解しやすいものにすること。
- セキュリティを考慮し、内部情報を漏洩させないこと。

## 型ヒント
- `from typing import` を使用して型をインポートすること。
- `Optional` 型を適切に使用すること。
- `List`, `Dict` など、ジェネリック型を活用すること。
- 戻り値の型を明示すること。

## 命名規則
- 変数・関数名: snake_case
- クラス名: PascalCase
- 定数名: UPPER_SNAKE_CASE
- プライベートメソッド: `_method_name`
- データベーステーブル名: 複数形の snake_case

## セキュリティ
- 入力値のバリデーションを必須とすること。
- SQL インジェクション対策を徹底すること。
- 認証情報をログに出力しないこと。
- CORS 設定を適切に行うこと。
- 機密情報は環境変数で管理すること。

## テスト
- 各エンドポイントに対してテストを作成すること。
- データベースのテストには分離されたテスト用DBを使用すること。
- 認証が必要なエンドポイントのテストを含めること。
- 異常系のテストも実装すること。

## ドキュメント
- docstring を使用して関数・クラスの説明を記述すること。
- 複雑なビジネスロジックにはインラインコメントを追加すること。
- APIドキュメントは FastAPI の自動生成機能を活用すること。

## パフォーマンス
- データベースクエリの最適化を行うこと。
- 不要な N+1 クエリを避けること。
- 適切なインデックスを設定すること。
- 大量データの処理にはページネーションを実装すること。
